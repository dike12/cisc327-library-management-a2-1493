name: CI

on: 
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  run-tests:
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest]  # Start with just one OS to debug
        python-version: ['3.11']  # Start with just one Python version
    
    runs-on: ${{ matrix.os }}
    
    timeout-minutes: 10

    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pytest pytest-cov
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
    
    - name: Debug - Show directory structure
      run: |
        echo "üìÅ Current directory structure:"
        ls -la
        echo "üìÅ Test directory:"
        ls -la test/ || echo "No test directory found"
        echo "üìÅ Root files:"
        ls -la *.py || echo "No Python files in root"
    
    - name: Debug - Check Python path and imports
      run: |
        echo "üêç Python path:"
        python -c "import sys; print('\n'.join(sys.path))"
        echo "üîç Testing imports:"
        python -c "
        try:
            from database import init_database, add_sample_data
            print('‚úÖ database imports work')
        except Exception as e:
            print(f'‚ùå database import failed: {e}')
        
        try:
            from library_service import add_book_to_catalog
            print('‚úÖ library_service imports work')
        except Exception as e:
            print(f'‚ùå library_service import failed: {e}')
        "
    
    - name: Initialize test database
      run: |
        python -c "
        try:
            from database import init_database, add_sample_data
            init_database()
            add_sample_data()
            print('‚úÖ Database initialized successfully')
            
            # Verify data was added
            from database import get_db_connection
            conn = get_db_connection()
            books = conn.execute('SELECT COUNT(*) as count FROM books').fetchone()['count']
            patrons = conn.execute('SELECT COUNT(*) as count FROM patrons').fetchone()['count']
            print(f'üìä Database now has: {books} books, {patrons} patrons')
            conn.close()
        except Exception as e:
            print(f'‚ùå Database initialization failed: {e}')
            import traceback
            traceback.print_exc()
        "
    
    - name: Run simple test first
      run: |
        python -c "
        # Test basic functionality
        from database import get_db_connection
        conn = get_db_connection()
        
        # Test 1: Check books exist
        books = conn.execute('SELECT * FROM books LIMIT 1').fetchall()
        print(f'üìö Found {len(books)} books')
        
        # Test 2: Try to add a book
        try:
            from library_service import add_book_to_catalog
            success, message = add_book_to_catalog('Test Book', 'Test Author', '1234567890123', 1)
            print(f'‚ûï Add book test: success={success}, message={message}')
        except Exception as e:
            print(f'‚ùå Add book failed: {e}')
        
        conn.close()
        "
    
    - name: Run tests with verbose output
      run: |
        # Run with very verbose output to see what's failing
        python -m pytest test/ -v -s --tb=long || echo "Tests failed, continuing..."
    
    - name: Run tests with coverage (even if some fail)
      run: |
        # Run tests but don't fail immediately
        python -m pytest test/ -v --cov=./ --cov-report=xml --continue-on-collection-errors || true
    
    - name: Debug - Check what files exist after tests
      run: |
        echo "üìÅ Files after tests:"
        ls -la
        echo "üìÅ Coverage files:"
        ls -la *.xml || echo "No XML files found"
        echo "üìÅ Pytest cache:"
        ls -la .pytest_cache/ || echo "No pytest cache found"
    
    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-results-${{ matrix.os }}-py${{ matrix.python-version }}
        path: |
          .pytest_cache
          coverage.xml
          test-results.xml
        retention-days: 7